import { useState } from 'react'
import { Div, Button, Span, Br } from '@startupjs/ui'
import { useProviders, ProvidersList2fa } from '@startupjs/2fa-manager'
import { CheckToken } from '@startupjs/2fa'

# 2fa-manager

Component for using various two-factor authentication methods.

## Installation

```js
  yarn add @startupjs/2fa-manager
```

## Connecting to startupjs

### server

Add the following lines to `server/index.js`:

```js
  import { initTwoFAManager } from '@startupjs/2fa-manager/server'
```

Add function to `startupjsServer`:

```js
  initTwoFAManager(ee, {
    providers: [
      {
        Provider: YOUR_PROVIDER1,
        options: YOUR_PROVIDER1_OPTIONS
      },{
        YOUR_PROVIDER2,
        options: YOUR_PROVIDER2_OPTIONS
      }]
  })
```

### Creating custom providers

You can create your own providers using the `Provider` class from `@startupjs/2fa-manager/Provider`.

Class `Provider(name, send, check)` where:

- `name` - string, provider name.
- `send()` - function of sending a message with a code.
- `check(code)` - function for checking the validity of the code.
  - `code` - the code to check.

## Example

```js
import { Provider } from '@startupjs/2fa-manager/Provider'

export default class CustomProvider extends Provider {
  constructor (ee, options) {
    super('testProvider')
    this.init(ee, options)
  }

  init (ee, options) {
    // your init, for example
    init2fa(ee, options)
  }

  send () {
    console.log('test code')
  }

  check (model, session, token) {
    if (token === 'test code') {
      console.log('Right code')
      return true
    } else {
      console.log('Wrong code')
      return false
    }
  }
}
```

Now this `Provider` can be registered with `initTwoFaManager` and used by the name `testProvider`.

## API

### server

### initTwoFaManager(ee, options)

- `ee` - eventEmitter of server.
- `options [Object]` - options object. Contains a list of providers:
  - `providers [Array]` - array of objects with providers.

### TwoFAManager

Singleton class that contains the following methods:

- `send(model, session, providerName)` - calls the `send` method of the provider `providerName`.
- `check(model, session, token, providerName)` - calls the `check` method of the provider `providerName`.
- `getProviders()` - returns an array of the names of the registered providers.

### client

### ProvidersList2fa(providers, chooseProvider)

Component for displaying a list of registered providers. Accepts the following props:

- `providers` - array of provider names
- `chooseProvider` - function, returns the name of the selected provider

```js
import { useProviders } from '@startupjs/2fa-manager'
```

```jsx example
const providers = useProviders()
const [currentProvider, setCurrentProvider] = useState('')
return pug`
  ProvidersList2fa(
    providers=providers
    chooseProvider=setCurrentProvider
  )
  Br
  if currentProvider
    Span= 'You chose the ' + currentProvider
`
```

## Example

```js
import { CheckToken } from '@startupjs/2fa'
```

```jsx example
const providers = useProviders()
const [currentProvider, setCurrentProvider] = useState('')

return pug`
  Div
    ProvidersBlock(onSubmit=(twoFA)=>console.log(twoFA.selectedProvider, twoFA.code))
`
```